version: "3"

vars:
  GIT_ROOT:
    sh: git -C "{{.USER_WORKING_DIR}}" rev-parse --show-toplevel
  USER:
    sh: git -C "{{.USER_WORKING_DIR}}" remote get-url origin |
      sed 's|.*github.com/||;s|\.git$||' |
      cut --delimiter="/" --fields=1
  REPO:
    sh: git -C "{{.USER_WORKING_DIR}}" remote get-url origin |
      sed 's|.*github.com/||;s|\.git$||' |
      cut --delimiter="/" --fields=2

tasks:
  default:
    deps:
      - common
      - github
      - pre-commit

  common:
    cmds:
      - cmd: rm --force --verbose "{{.GIT_ROOT}}/{{.ITEM}}"
        for:
          - .github/sync-repo-settings.yaml
          - .github/workflows/license.yaml
        silent: true
      - cmd: install -D --mode="u=rw,go=r" --no-target-directory --verbose
          "{{.TASKFILE_DIR}}/{{.ITEM}}" "{{.GIT_ROOT}}/{{.ITEM}}"
        for:
          - .github/auto-label.yaml
          - .github/blunderbuss.yml
          - .github/dependabot.yaml
          - .github/workflows/merge.yaml
          - .github/workflows/pre-commit.yaml
          - .github/workflows/template.yaml
          - .pre-commit-config.yaml
        silent: true
    run: once

  github:
    cmd: bash "{{.TASKFILE_DIR}}/scripts/gh-init.sh" "{{.USER}}" "{{.REPO}}"
    ignore_error: true

  pre-commit:
    deps:
      - common
    cmd: pre-commit install --install-hooks --hook-type="commit-msg" --hook-type="pre-commit"
    ignore_error: true
